<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Admin Portal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <a class="navbar-brand" href="/">401 Stock App</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/portfolio">Portfolio</a>
          </li>
          {% if session.get('user_id') %}
          <li class="nav-item">
            <a class="nav-link" href="/logout">Logout</a>
          </li>
          {% else %}
          <li class="nav-item">
            <a class="nav-link" href="/login">Login</a>
          </li>
          {% endif %}
        </ul>
      </div>
    </nav>

    <div class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'users' %}active{% endif %}" href="{{ url_for('admin_portal', tab='users') }}">Admin Portal</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'market' %}active{% endif %}" href="{{ url_for('admin_portal', tab='market') }}">Market Settings</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'stocks' %}active{% endif %}" href="{{ url_for('admin_portal', tab='stocks') }}">Stocks</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'activity' %}active{% endif %}" href="{{ url_for('admin_portal', tab='activity') }}">Admin Activity</a>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade {% if active_tab == 'users' %}show active{% endif %}" id="users" role="tabpanel">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Users</h5>
              <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_customers') }}">Customers Page</a>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-striped mb-0">
                  <thead class="thead-light">
                    <tr>
                      <th scope="col">First Name</th>
                      <th scope="col">Last Name</th>
                      <th scope="col">Email</th>
                      <th scope="col">Admin</th>
                      <th scope="col">Reset Password</th>
                      <th scope="col" class="text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for user in users %}
                      <form id="user-form-{{ user.id }}" method="post">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        <input type="hidden" name="tab" value="users">
                      </form>
                      <tr>
                        <td>
                          <input type="text" class="form-control form-control-sm user-row-input" name="first_name" value="{{ user.first_name or '' }}" form="user-form-{{ user.id }}">
                        </td>
                        <td>
                          <input type="text" class="form-control form-control-sm user-row-input" name="last_name" value="{{ user.last_name or '' }}" form="user-form-{{ user.id }}">
                        </td>
                        <td>
                          <input type="email" class="form-control form-control-sm user-row-input" name="email" value="{{ user.email }}" form="user-form-{{ user.id }}">
                        </td>
                        <td class="text-center">
                          <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input user-row-input" id="admin-{{ user.id }}" name="is_admin" form="user-form-{{ user.id }}" {% if user.is_admin %}checked{% endif %}>
                            <label class="custom-control-label" for="admin-{{ user.id }}"></label>
                          </div>
                        </td>
                        <td>
                          <input type="password" class="form-control form-control-sm user-row-input" name="new_password" placeholder="New password" form="user-form-{{ user.id }}">
                        </td>
                        <td class="text-right">
                          <button type="submit" class="btn btn-primary btn-sm save-btn" form="user-form-{{ user.id }}" disabled>Save</button>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade {% if active_tab == 'market' %}show active{% endif %}" id="market" role="tabpanel">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Default Market Hours</h5>
            </div>
            <div class="card-body">
              <p class="mb-1">Regular trading hours: <strong>{{ default_open_time }}</strong> – <strong>{{ default_close_time }}</strong> ET, Monday through Friday.</p>
              {% if market_status_summary and market_status_summary.is_open %}
                <p class="mb-0 text-success">Markets are currently open and will close at {{ market_status_summary.closes_at.strftime('%I:%M %p %Z').lstrip('0') if market_status_summary.closes_at else default_close_time + ' ET' }}.</p>
              {% elif market_status_summary %}
                <p class="mb-0 text-warning">
                  {{ market_status_summary.message or 'Markets are closed.' }}
                  {% if market_status_summary.next_open %}
                    Next session begins {{ market_status_summary.next_open.strftime('%A, %B %d %I:%M %p %Z').lstrip('0') }}.
                  {% endif %}
                </p>
              {% endif %}
            </div>
          </div>

          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Schedule Overrides</h5>
              <small class="text-muted">Use overrides for holidays or adjusted hours.</small>
            </div>
            <div class="card-body">
              <form method="post" class="border rounded p-3 mb-4 schedule-form">
                <input type="hidden" name="tab" value="market">
                <input type="hidden" name="action" value="save_override">
                <div class="form-row">
                  <div class="form-group col-md-3">
                    <label for="override-date">Date</label>
                    <input type="date" class="form-control" id="override-date" name="override_date" required>
                  </div>
                  <div class="form-group col-md-3">
                    <label for="open-time">Open Time</label>
                    <input type="time" class="form-control" id="open-time" name="open_time" value="09:30">
                  </div>
                  <div class="form-group col-md-3">
                    <label for="close-time">Close Time</label>
                    <input type="time" class="form-control" id="close-time" name="close_time" value="16:00">
                  </div>
                  <div class="form-group col-md-3 d-flex align-items-center">
                    <div class="custom-control custom-checkbox mt-4">
                      <input type="checkbox" class="custom-control-input" id="market-closed" name="is_closed">
                      <label class="custom-control-label" for="market-closed">Market closed</label>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="override-note">Note</label>
                  <input type="text" class="form-control" id="override-note" name="note" placeholder="Optional reason or context">
                </div>
                <button type="submit" class="btn btn-primary">Save Override</button>
              </form>

              <div class="table-responsive">
                <table class="table table-striped mb-0">
                  <thead class="thead-light">
                    <tr>
                      <th scope="col">Date</th>
                      <th scope="col">Status</th>
                      <th scope="col">Open</th>
                      <th scope="col">Close</th>
                      <th scope="col">Note</th>
                      <th scope="col" class="text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if market_overrides %}
                      {% for override in market_overrides %}
                        <tr>
                          <td>{{ override.date.strftime('%A, %B %d, %Y') }}</td>
                          <td>
                            {% if override.is_closed %}
                              <span class="badge badge-danger">Closed</span>
                            {% else %}
                              <span class="badge badge-success">Open</span>
                            {% endif %}
                          </td>
                          <td>{{ override.open_time.strftime('%I:%M %p') if override.open_time else '—' }}</td>
                          <td>{{ override.close_time.strftime('%I:%M %p') if override.close_time else '—' }}</td>
                          <td>{{ override.note or '—' }}</td>
                          <td class="text-right">
                            <form method="post" class="d-inline">
                              <input type="hidden" name="tab" value="market">
                              <input type="hidden" name="action" value="delete_override">
                              <input type="hidden" name="override_id" value="{{ override.id }}">
                              <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                            </form>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="6" class="text-center text-muted py-4">No overrides configured.</td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade {% if active_tab == 'stocks' %}show active{% endif %}" id="stocks" role="tabpanel">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Add New Stock</h5>
            </div>
            <div class="card-body">
              <form method="post">
                <input type="hidden" name="tab" value="stocks">
                <input type="hidden" name="action" value="create_stock">
                <div class="form-row">
                  <div class="form-group col-md-3">
                    <label for="new-market">Market</label>
                    <input type="text" class="form-control" id="new-market" name="market" placeholder="e.g. NASDAQ" required>
                  </div>
                  <div class="form-group col-md-3">
                    <label for="new-symbol">Symbol</label>
                    <input type="text" class="form-control" id="new-symbol" name="symbol" placeholder="e.g. AAPL" required>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="new-name">Company Name</label>
                    <input type="text" class="form-control" id="new-name" name="name" placeholder="Apple Inc." required>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-3">
                    <label for="new-lastsale">Last Sale Price</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="new-lastsale" name="lastsale" required>
                  </div>
                  <div class="form-group col-md-3">
                    <label for="new-volume">Volume</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="new-volume" name="volume" placeholder="Optional">
                  </div>
                  <div class="form-group col-md-3">
                    <label for="new-marketcap">Market Cap</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="new-marketcap" name="marketCap" placeholder="Optional">
                  </div>
                  <div class="form-group col-md-3">
                    <label for="new-country">Country</label>
                    <input type="text" class="form-control" id="new-country" name="country" placeholder="Optional">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-4">
                    <label for="new-industry">Industry</label>
                    <input type="text" class="form-control" id="new-industry" name="industry" placeholder="Optional">
                  </div>
                  <div class="form-group col-md-4">
                    <label for="new-sector">Sector</label>
                    <input type="text" class="form-control" id="new-sector" name="sector" placeholder="Optional">
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">Create Stock</button>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Update Existing Stock</h5>
            </div>
            <div class="card-body">
              <form method="get" class="form-row align-items-end mb-3">
                <input type="hidden" name="tab" value="stocks">
                <div class="form-group col-md-4">
                  <label for="search-symbol">Stock Symbol</label>
                  <input type="text" class="form-control" id="search-symbol" name="stock_symbol" value="{{ stock_search_symbol or '' }}" placeholder="Enter symbol" required>
                </div>
                <div class="form-group col-md-2">
                  <button type="submit" class="btn btn-outline-secondary">Load Stock</button>
                </div>
              </form>

              {% if stock_search_symbol and not stock_to_edit %}
                <p class="text-muted">No stock details available for {{ stock_search_symbol }}.</p>
              {% endif %}

              {% if stock_to_edit %}
              <form method="post" class="border rounded p-3">
                <input type="hidden" name="tab" value="stocks">
                <input type="hidden" name="action" value="update_stock">
                <input type="hidden" name="original_symbol" value="{{ stock_to_edit.symbol }}">
                <input type="hidden" name="original_market" value="{{ stock_to_edit.market }}">
                <div class="form-row">
                  <div class="form-group col-md-3">
                    <label for="edit-market">Market</label>
                    <input type="text" class="form-control" id="edit-market" name="market" value="{{ stock_to_edit.market }}" required>
                  </div>
                  <div class="form-group col-md-3">
                    <label for="edit-symbol">Symbol</label>
                    <input type="text" class="form-control" id="edit-symbol" name="symbol" value="{{ stock_to_edit.symbol }}" required>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="edit-name">Company Name</label>
                    <input type="text" class="form-control" id="edit-name" name="name" value="{{ stock_to_edit.name }}" required>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-3">
                    <label for="edit-lastsale">Last Sale Price</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="edit-lastsale" name="lastsale" value="{{ '%.2f' % stock_to_edit.lastsale if stock_to_edit.lastsale is not none else '' }}" required>
                  </div>
                  <div class="form-group col-md-3">
                    <label for="edit-volume">Volume</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="edit-volume" name="volume" value="{{ stock_to_edit.volume if stock_to_edit.volume is not none else '' }}">
                  </div>
                  <div class="form-group col-md-3">
                    <label for="edit-marketcap">Market Cap</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="edit-marketcap" name="marketCap" value="{{ stock_to_edit.market_cap if stock_to_edit.market_cap is not none else '' }}">
                  </div>
                  <div class="form-group col-md-3">
                    <label for="edit-country">Country</label>
                    <input type="text" class="form-control" id="edit-country" name="country" value="{{ stock_to_edit.country or '' }}">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-4">
                    <label for="edit-industry">Industry</label>
                    <input type="text" class="form-control" id="edit-industry" name="industry" value="{{ stock_to_edit.industry or '' }}">
                  </div>
                  <div class="form-group col-md-4">
                    <label for="edit-sector">Sector</label>
                    <input type="text" class="form-control" id="edit-sector" name="sector" value="{{ stock_to_edit.sector or '' }}">
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="tab-pane fade {% if active_tab == 'activity' %}show active{% endif %}" id="activity" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Admin Login Activity</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-striped mb-0">
                  <thead class="thead-light">
                    <tr>
                      <th scope="col">Admin</th>
                      <th scope="col">Login Time</th>
                      <th scope="col">Logout Time</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if admin_logs %}
                      {% for name, login_at, logout_at in admin_logs %}
                        <tr>
                          <td>{{ name }}</td>
                          <td>{{ login_at.strftime('%Y-%m-%d %H:%M:%S') if login_at else '—' }}</td>
                          <td>{{ logout_at.strftime('%Y-%m-%d %H:%M:%S') if logout_at else '—' }}</td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="3" class="text-center text-muted py-4">No admin login activity recorded yet.</td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script>
      (function() {
        var forms = document.querySelectorAll('form[id^="user-form-"]');
        Array.prototype.forEach.call(forms, function(form) {
          var saveButton = document.querySelector('button.save-btn[form="' + form.id + '"]');
          var inputs = document.querySelectorAll('[form="' + form.id + '"]');
          Array.prototype.forEach.call(inputs, function(input) {
            input.addEventListener('input', function() {
              saveButton.disabled = false;
            });
            if (input.type === 'checkbox') {
              input.addEventListener('change', function() {
                saveButton.disabled = false;
              });
            }
          });
        });

        var marketClosedCheckbox = document.getElementById('market-closed');
        var openTimeInput = document.getElementById('open-time');
        var closeTimeInput = document.getElementById('close-time');

        function toggleTimeInputs() {
          var disabled = marketClosedCheckbox.checked;
          openTimeInput.disabled = disabled;
          closeTimeInput.disabled = disabled;
        }

        if (marketClosedCheckbox) {
          marketClosedCheckbox.addEventListener('change', toggleTimeInputs);
          toggleTimeInputs();
        }
      })();
    </script>
  </body>
</html>
