<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Customer Profile</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">
    <style>
      .profile-header {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
      }
      .card {
        margin-bottom: 2rem;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="profile-header">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="h2 mb-1">My Profile</h1>
            <p class="lead mb-0">View and update your account information</p>
          </div>
          <div class="col-md-4 text-right">
            {% if session.user_name %}
            <p class="mb-0">Welcome, <strong>{{ session.user_name }}</strong></p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-primary text-white">Account Information</div>
            <div class="card-body">
              <form method="post" action="{{ url_for('update_profile') }}">
                <div class="form-group">
                  <label for="full_name">Full Name</label>
                  <input type="text" class="form-control" id="full_name" name="full_name" value="{{ user.full_name }}" required>
                </div>
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
                </div>
                <div class="form-group">
                  <label for="password">Password</label>
                  <input type="password" class="form-control" id="password" name="password" placeholder="Leave blank to keep current password">
                </div>
                <button type="submit" class="btn btn-success">Update Profile</button>
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-info text-white">Saved Payment Information</div>
            <div class="card-body">
              <!-- Debug Information Display -->
              {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                  {% for category, message in messages %}
                    <div class="alert alert-{{ category }} mb-4">
                      {% if '\n' in message %}
                        <pre class="mb-0">{{ message }}</pre>
                      {% else %}
                        {{ message }}
                      {% endif %}
                    </div>
                  {% endfor %}
                {% endif %}
              {% endwith %}
              <form method="POST" action="{{ url_for('save_payment_info') }}" id="paymentForm" onsubmit="return validateForm()">
                <div class="form-group">
                  <label for="payment_type">Payment Type</label>
                  <select class="form-control" id="payment_type" name="payment_type" required onchange="togglePaymentFields()">
                    <option value="">Select...</option>
                    <option value="credit" {% if payment and payment.payment_type == 'credit' %}selected{% endif %}>Credit Card</option>
                    <option value="debit" {% if payment and payment.payment_type == 'debit' %}selected{% endif %}>Debit Card</option>
                    <option value="bank" {% if payment and payment.payment_type == 'bank' %}selected{% endif %}>Bank Account</option>
                  </select>
                </div>
                <div id="card-fields" style="display:none;">
                  <div class="form-group">
                    <label for="card_name">Name on Card</label>
                    <input type="text" class="form-control" id="card_name" name="card_name" 
                           value="{{ payment.card_name if payment else '' }}" 
                           pattern="[A-Za-z ]{2,100}" 
                           title="Please enter a valid name (letters and spaces only)">
                  </div>
                  <div class="form-group">
                    <label for="card_number">Card Number</label>
                    <input type="text" class="form-control" id="card_number" name="card_number" 
                           maxlength="19" pattern="\d{4}[\s\d]{0,15}"
                           title="Please enter a valid card number"
                           {% if payment and payment.card_number_last4 %}
                           placeholder="**** **** **** {{ payment.card_number_last4 }}"
                           {% endif %}>
                    {% if payment and payment.card_number_last4 %}
                    <small class="text-muted">Current card ends in {{ payment.card_number_last4 }}</small>
                    {% endif %}
                  </div>
                  <div class="form-group">
                    <label for="card_expiration">Expiration (MM/YYYY)</label>
                    <input type="text" class="form-control" id="card_expiration" name="card_expiration" 
                           placeholder="MM/YYYY" pattern="\d{2}/\d{4}"
                           title="Please enter date in MM/YYYY format. Year must be between current year and 20 years in future."
                           value="{% if payment and payment.card_expiration %}{{ payment.card_expiration }}{% endif %}">
                  </div>
                </div>
                <div id="bank-fields" style="display:none;">
                  <div class="form-group">
                    <label for="bank_account_number">Checking Account Number</label>
                    <input type="text" class="form-control" id="bank_account_number" name="bank_account_number" 
                           value="{{ payment.bank_account_number if payment else '' }}"
                           pattern="\d{4,17}"
                           title="Please enter a valid account number (4-17 digits)"
                           maxlength="17">
                  </div>
                  <div class="form-group">
                    <label for="bank_routing_number">Routing Number</label>
                    <input type="text" class="form-control" id="bank_routing_number" name="bank_routing_number" 
                           value="{{ payment.bank_routing_number if payment else '' }}"
                           pattern="\d{9}"
                           title="Please enter a valid 9-digit routing number"
                           maxlength="9">
                  </div>
                </div>
                <button type="submit" class="btn btn-info btn-lg btn-block mt-4">Save Payment Info</button>
              </form>
              <div id="submitStatus"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function validateForm() {
        var paymentType = document.getElementById('payment_type').value;
        if (!paymentType) {
          alert('Please select a payment type');
          return false;
        }

        if (paymentType === 'credit' || paymentType === 'debit') {
          var cardName = document.getElementById('card_name').value;
          var cardNumber = document.getElementById('card_number').value;
          var cardExpiration = document.getElementById('card_expiration').value;

          if (!cardName || !cardNumber || !cardExpiration) {
            alert('Please fill in all card details');
            return false;
          }
        } else if (paymentType === 'bank') {
          var accountNumber = document.getElementById('bank_account_number').value;
          var routingNumber = document.getElementById('bank_routing_number').value;

          if (!accountNumber || !routingNumber) {
            alert('Please fill in all bank account details');
            return false;
          }
        }
        return true;
      }

      function togglePaymentFields() {
        var type = document.getElementById('payment_type').value;
        var cardFields = document.getElementById('card-fields');
        var bankFields = document.getElementById('bank-fields');
        
        
        cardFields.style.display = (type === 'credit' || type === 'debit') ? 'block' : 'none';
        bankFields.style.display = (type === 'bank') ? 'block' : 'none';

        
        var cardInputs = cardFields.getElementsByTagName('input');
        var bankInputs = bankFields.getElementsByTagName('input');
        
        for (var i = 0; i < cardInputs.length; i++) {
          cardInputs[i].required = (type === 'credit' || type === 'debit');
        }
        
        for (var i = 0; i < bankInputs.length; i++) {
          bankInputs[i].required = (type === 'bank');
        }
      }

      
      document.addEventListener('DOMContentLoaded', function() {
        togglePaymentFields();

        
        var expirationInput = document.getElementById('card_expiration');
        expirationInput.addEventListener('input', function(e) {
          var value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.substr(0, 2) + '/' + value.substr(2);
          }
          e.target.value = value.substr(0, 7);
        });

        // Add validation for expiration date
        expirationInput.addEventListener('change', function(e) {
          var value = e.target.value;
          if (value) {
            var parts = value.split('/');
            if (parts.length === 2) {
              var month = parseInt(parts[0], 10);
              var year = parseInt(parts[1], 10);
              var currentYear = new Date().getFullYear();
              
              if (month < 1 || month > 12) {
                alert('Invalid month. Please enter a month between 01 and 12.');
                e.target.value = '';
              } else if (year < currentYear || year > currentYear + 20) {
                alert('Invalid year. Expiration year must be between ' + currentYear + ' and ' + (currentYear + 20));
                e.target.value = '';
              }
            }
          }
        });

        
        var cardNumberInput = document.getElementById('card_number');
        cardNumberInput.addEventListener('input', function(e) {
          var value = e.target.value.replace(/\D/g, '');
          var formattedValue = '';
          for (var i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) {
              formattedValue += ' ';
            }
            formattedValue += value[i];
          }
          e.target.value = formattedValue.substr(0, 19);
        });
      });
    </script>
  </body>
</html>
